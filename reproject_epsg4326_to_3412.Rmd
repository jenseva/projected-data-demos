---
title: "Convert Lat-Lon Coordinates to Polar Stereo"
author: "g. Cutter and D. Kinzey"
date: "11/8/2020"
output: html_document
---

>notebook filename | reproject_epsg3412_to_4326.Rmd  
history | Nov 2020: Converted to Rmd notebook, added ERRDAP lat-lon coordinate retrieval, J. Sevadjian. Feb 2020:  Created code snippet, simplified from: AMLR_GIS_in_R by RG. Cutter and D. Kinzey. Nov 2017: AMLR_GIS_in_R.R, G Cutter.

This R code demonstrates converting latitude longitude coordinates to projected coordinates. We will access a dataset with coordinates of WGS84 lat, lon (EPSG:4326) and convert the coordinates to NSIDC Sea Ice Polar Stereographic South (EPSG: 3412).


## Install required packages and load libraries

The required packages are **maptools**, **rgdal**, and **sp**.

```{r setup_packages, message=FALSE, warning=FALSE}

# Function to check if pkgs are installed, install missing pkgs, and load
pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,dep=TRUE,repos='http://cran.us.r-project.org')
    if(!require(x,character.only = TRUE)) stop(x, " :Package not found")
  }
}

list.of.packages <- c("maptools","rgdal","sp")

# create list of installed packages
pkges = installed.packages()[,"Package"]
for (pk in list.of.packages) {
  pkgTest(pk)
}

```


## Access coordinate variables from PolarWatch ERDDAP server

We will use the BGC Argo float in-situ dataset as our dataset. This dataset has latitude longitude coordinates.  

* Request and download the coordinate variables from ERDDAP
* The request url was generated using the dataset data access form online at https://polarwatch.noaa.gov/erddap/tabledap/SOCCOM_BGC_Argo_Snapshot_Archive.html
* There are many additional file format options with ERDDAP, here we demonstrate working with csv output.

```{r}

url <- 'https://polarwatch.noaa.gov/erddap/tabledap/SOCCOM_BGC_Argo_Snapshot_Archive.csv0?latitude%2Clongitude&time%3E=2020-08-23T00%3A00%3A00Z&time%3C=2020-08-30T02%3A34%3A00Z'

download.file(url, destfile='lat_lon_coordinates_input.csv')

```

## Read in the coordinates file

* Read in the .csv file from our working directory
* Create a dataframe of coordinate points

```{r load_data }

infn = "lat_lon_coordinates_input.csv"

indata = read.csv( infn, header=FALSE)

```
##  Create Spatial Dataframe

Convert the coordinate points dataframe to a spatial object (spatial dataframe)

```{r spatial_dataframe}

latitude <- indata$V1
longitude <- indata$V2

# Longitude for this dataset goes from 0-360 but the transform library uses -180/180
# Convert from 360 to -180/180
lon180 <- ((longitude + 180) %% 360) - 180
indata$V2 <- lon180

dfcoords = cbind(lon180,latitude)      # coords in lon, lat order
sppoints = SpatialPoints(coords = indata)
spdf     = SpatialPointsDataFrame(coords = dfcoords, indata)

# Verify initial coordinates of spatial dataframe
coordsinit <- spdf@coords

```

## Reproject data from EPSG:3412 to EPSG:4326 

* Define each of the coordinate reference systems (EPSG:3412 and EPSG:4326)
* Transform the coordinates to Lat Lon with spTransform
* Check new coordinates with coords and bbox

```{r reproject, message=FALSE, warning=FALSE}

# Define coordinate reference systems
crslonglat       = CRSargs(CRS("+init=epsg:4326")) # order is longitude latitude in R CRS
crsseaicepolster3412 = CRSargs(CRS("+init=epsg:3412"))

# Set initial CRS of spatial dataframe
proj4string(spdf) = CRS(crslonglat)
lat_lon_bbox       = spdf@bbox
print(lat_lon_bbox)

# Check that CRS is set
crs_set = proj4string(spdf)

# Converts from existing lat-lon crs to polar stereo (3412)
spdfProjected = spTransform(spdf, CRS(crsseaicepolster3412))  
crs_projected = proj4string(spdfProjected)

coordsproj = spdfProjected@coords
bbox       = spdfProjected@bbox
print( bbox )
